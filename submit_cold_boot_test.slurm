#!/bin/bash
#SBATCH --job-name=test          # ä½œä¸šå
#SBATCH --partition=gpuA800                # GPUé˜Ÿåˆ—
#SBATCH -N 1                               # 1ä¸ªèŠ‚ç‚¹
#SBATCH --ntasks-per-node=1                # æ¯èŠ‚ç‚¹1ä¸ªä»»åŠ¡
#SBATCH --cpus-per-task=8                  # 1:8çš„GPU:CPUé…æ¯”
#SBATCH --gres=gpu:1                       # nå—GPU
#SBATCH --time=14400                       # 10å¤©
#SBATCH --mail-type=begin                  # ä½œä¸šå¼€å§‹æ—¶å‘é‚®ä»¶
#SBATCH --mail-type=end                    # ä½œä¸šç»“æŸæ—¶å‘é‚®ä»¶
#SBATCH --mail-user=790335643@qq.com
#SBATCH --output=/share/home/202520143336/outputlog/%j.out                 # è¾“å‡ºæ–‡ä»¶
#SBATCH --error=/share/home/202520143336/outputlog/%j.err                 # è¾“å‡ºæ–‡ä»¶


# æ‰“å°ä½œä¸šä¿¡æ¯
echo "========================================================================"
echo "  HyPE on API-Bank - Cold Boot Test (5 Samples)"
echo "========================================================================"
echo "Job ID: $SLURM_JOB_ID"
echo "Node: $SLURM_NODELIST"
echo "Start time: $(date)"
echo "========================================================================"
echo ""

# æ¿€æ´» conda ç¯å¢ƒ
source ~/anaconda3/etc/profile.d/conda.sh
conda activate ag

# è®¾ç½® CUDA ç¯å¢ƒå˜é‡
export LD_LIBRARY_PATH=$CONDA_PREFIX/lib/python3.10/site-packages/nvidia/cuda_runtime/lib:$LD_LIBRARY_PATH
export CUDA_HOME=$CONDA_PREFIX

# ğŸ”¥ ç¦ç”¨ bitsandbytes é‡åŒ–
export BITSANDBYTES_NOWELCOME=1
export DISABLE_BITSANDBYTES=1

# è®¾ç½® HuggingFace é•œåƒ
export HF_ENDPOINT=https://hf-mirror.com

# æ‰“å°ç¯å¢ƒä¿¡æ¯
echo "Python: $(which python)"
echo "Python version: $(python --version)"
echo "CUDA available: $(python -c 'import torch; print(torch.cuda.is_available())')"
echo "GPU: $(python -c 'import torch; print(torch.cuda.get_device_name(0) if torch.cuda.is_available() else "N/A")')"
echo ""

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /share/home/202520143336/project/hype

# è¿è¡Œ cold bootï¼ˆ5ä¸ªæ ·ä¾‹ç”¨äºå¿«é€Ÿæµ‹è¯•ï¼‰
python cold_boot_apibank.py \
    --data-path ./data/apibank/train.json \
    --config config_hpc.yaml \
    --output-dir ./output/apibank_hpc/cold_boot_test \
    --num-tasks 10 \
    --evolution-interval 5 \
    --checkpoint-interval 5

echo ""
echo "========================================================================"
echo "Job completed at: $(date)"
echo "========================================================================"
